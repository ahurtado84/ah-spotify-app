<!DOCTYPE html>
<html lang="en">
    <head> 
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Spotify App</title>
		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 0;
				padding: 0;
				background-color: #121212;
				color: white;
				display: flex;
				flex-direction: column;
				height: 100vh;
				overflow: hidden;
			}
	
			.header {
				padding: 20px;
				background-color: #1DB954;
				text-align: center;
				font-size: 24px;
				font-weight: bold;
			}
	
			.video-container {
				width: 100%;
				height: 200px;
				background-color: black;
				display: flex;
				justify-content: center;
				align-items: center;
				flex-direction: column;
			}
	
			video {
				width: 100%;
				height: 100%;
				object-fit: cover;
				display: none; /* Hide by default */
			}
	
			.controls-bar {
				display: flex;
				justify-content: space-around;
				background-color: #282828;
				padding: 10px 0;
				width: 100%;
			}
	
			.controls-bar .control-item {
				text-align: center;
				color: white;
				font-size: 14px;
				padding: 10px 20px;
				background-color: #1DB954;
				border-radius: 20px;
				cursor: pointer;
			}
	
			.playlist-container, .track-container {
				flex: 1;
				overflow-y: auto;
				padding: 20px;
			}
	
			.playlist, .track-list {
				display: flex;
				flex-direction: column;
				gap: 15px;
			}
	
			.playlist-item, .track-item {
				display: flex;
				align-items: center;
				background-color: #282828;
				padding: 10px;
				border-radius: 10px;
				cursor: pointer;
			}
	
			.playlist-item img, .track-item img {
				width: 50px;
				height: 50px;
				border-radius: 5px;
				margin-right: 15px;
			}
	
			.playlist-item .details, .track-item .details {
				flex: 1;
			}
	
			.playlist-item .details .title, .track-item .details .title {
				font-size: 16px;
				font-weight: bold;
			}
	
			.playlist-item .details .description, .track-item .details .description {
				font-size: 14px;
				color: #b3b3b3;
			}
	
			.menu-bar {
				display: flex;
				justify-content: space-around;
				background-color: #282828;
				padding: 10px 0;
				position: sticky;
				bottom: 0;
				width: 100%;
			}
	
			.menu-bar .menu-item {
				text-align: center;
				color: #b3b3b3;
				font-size: 12px;
			}
	
			.menu-bar .menu-item img {
				width: 24px;
				height: 24px;
				margin-bottom: 5px;
			}
	
			/* Hide the track container by default */
			.track-container {
				display: none;
			}
	
			/* Hide the controls-bar by default */
			.controls-bar {
				display: none;
			}
	
			/* Mobile-specific styling */
			@media (max-width: 768px) {
				.playlist-item img, .track-item img {
					width: 40px;
					height: 40px;
				}
	
				.playlist-item .details .title, .track-item .details .title {
					font-size: 14px;
				}
	
				.playlist-item .details .description, .track-item .details .description {
					font-size: 12px;
				}
			}
		</style>
	</head> 
    <body> 
		<div class="header">
			<img src="https://storage.googleapis.com/pr-newsroom-wp/1/2023/05/Spotify_Primary_Logo_RGB_Black.png" alt="Logo" style="vertical-align: middle; margin-right: 10px; width: 50px; height: 50px;">
			<span>Spotify</span>
			<div style="float: right; display: flex; align-items: center;">
				<span style="margin-right: 10px; font-size: 14px;" id="user-name"></span>
				<img src="https://via.placeholder.com/50" style="width: 50px; height: 50px;" id="user-picture">
			</div>
		</div>
	 
		<!-- Video Container -->
		<div class="video-container">
			<video id="videoPlayer" controls></video>
		</div>
	
		<!-- Controls Bar -->
		<div class="controls-bar">
			<div class="control-item" onclick="playAll()">Play All</div>
			<div class="control-item" onclick="playRandom()">Random Order</div>
		</div>
	
		<!-- Playlist Container -->
		<div class="playlist-container">
			<div class="playlist" id="playlist">
			</div>
		</div>
	
		<!-- Track Container -->
		<div class="track-container">
			<div class="header" id="backBtn" onclick="showLibrary()">Back</div>
			<div class="track-list" id="track-list">
				<!-- Tracks will be inserted here dynamically -->
			</div>
		</div>
	
		<div class="menu-bar">
			<div class="menu-item">
				<img src="https://via.placeholder.com/24" alt="Home">
				<div>Home</div>
			</div> 
			<div class="menu-item">
				<img src="https://via.placeholder.com/24" alt="Search">
				<div>Search</div>
			</div>
			<div class="menu-item" onclick="showLibrary()">
				<img src="https://via.placeholder.com/24" alt="Library">
				<div>Your Library</div>
			</div> 
		</div> 
   
		<!--Order matters, loading first spotify as app-script depends on them -->
		<script src="src/spotify-api-script.js" type="module"></script>
		<script type="module">
			import { getSpotifyAccessToken, fetchSpotifyProfile, fetchSpotifyPlaylists, fetchSpotifyPlaylistTracks, fetchTrackStream } from './src/spotify-api-script.js';
 
			main();     
 
			async function main() {
				const accessToken = await getSpotifyAccessToken();
			
				const profile = await fetchSpotifyProfile(accessToken);
				populateUI(profile);
				// print(profile);

				const playlists_obj = await fetchSpotifyPlaylists(accessToken, profile.id);
				populatePlaylists(playlists_obj, accessToken);
				// print(playlists);
			}

			function populatePlaylists(playlists_obj, accessToken){
				const playlistContainer = document.getElementById('playlist');
				playlistContainer.innerHTML = '';
				playlists_obj.forEach(playlist_obj => {
					const playlistItem = document.createElement('div');
					playlistItem.id = playlist_obj.id;
					playlistItem.className = 'playlist-item';
					playlistItem.onclick = () => populateTracks(playlist_obj.id, accessToken);

					const img = document.createElement('img');
					if ('images' in playlist_obj && playlist_obj.images.length > 0) {
						img.src = playlist_obj.images[playlist_obj.images.length-1].url;
					}
					else {
						img.src = "https://via.placeholder.com/50";
					}
					playlistItem.appendChild(img);

					const details = document.createElement('div');
					details.className = 'details';
					const title = document.createElement('div');
					title.className = 'title';	
					title.textContent = playlist_obj.name;				
					const description = document.createElement('div');
					description.className = 'description';	
					description.textContent = playlist_obj.description;				
					details.appendChild(title);
					details.appendChild(description);
					playlistItem.appendChild(details);

					playlistContainer.appendChild(playlistItem);
				});
			}

			async function populateTracks(playlistId, accessToken){
			// Display that view
			showTracks();

			// Get the tracks
			const tracks_array = await fetchSpotifyPlaylistTracks(accessToken, playlistId);
			print(tracks_array);
			// Add tracks based on the playlist selected
			const trackListContainer = document.getElementById('track-list');
            trackListContainer.innerHTML = ''; // Clear previous tracks
			tracks_array.forEach((item, index) => {
				const track_item = item.track;
				const trackItem = document.createElement('div');
				trackItem.className = 'track-item';
				trackItem.id = track_item.id;
				trackItem.onclick = () => playVideo(track_item);

				const img = document.createElement('img');
					if ('album' in track_item && 'images' in track_item.album && track_item.album.images.length > 0) {
						img.src = track_item.album.images[track_item.album.images.length-1].url;
					}
					else {
						img.src = "https://via.placeholder.com/50";
					}
					trackItem.appendChild(img);

					const details = document.createElement('div');
					details.className = 'details';
					const title = document.createElement('div');
					title.className = 'title';	
					title.textContent = track_item.name;				
								
					details.appendChild(title);
					trackItem.appendChild(details);

					trackListContainer.appendChild(trackItem);

				});
			}

			async function playVideo(trackItem) {
				const videoPlayer = document.getElementById('videoPlayer');
				let media_url = 'https://www.w3schools.com/html/mov_bbb.mp4';
				try {
					const trackStrem = await fetchTrackStream(trackItem.id);
					if ('link' in trackStrem){
						media_url = trackStrem.link;
					} else {
						media_url = trackItem.preview_url;
					}
				} catch (error) {
					media_url = trackItem.preview_url;
				}
				
				videoPlayer.src = media_url; // `https://www.w3schools.com/html/mov_bbb.mp4` Replace with your video source
				videoPlayer.style.display = 'block';
				videoPlayer.play();
			}

			function print(obj) {
				const jsonString = JSON.stringify(obj, null, 2);
				console.log(jsonString);

			}

			function populateUI(profile) {
				document.getElementById("user-name").innerText = profile.display_name;
				if (profile.images.length > 0) {
					document.getElementById("user-picture").src = profile.images[0].url;
				}
			}

		</script>
		<script>

			function showLibrary() {
				// Hide the track container and show the playlist container
				document.querySelector('.track-container').style.display = 'none';
				document.querySelector('.controls-bar').style.display = 'none';
				document.querySelector('.playlist-container').style.display = 'block';

				// Hide the video player
				const videoPlayer = document.getElementById('videoPlayer');
				// videoPlayer.pause();  // Stop the video when going back
				videoPlayer.style.display = 'none';
			}

			function showTracks() {
				// Hide the playlist container and show the track container
				document.querySelector('.playlist-container').style.display = 'none';
                document.querySelector('.track-container').style.display = 'block';
			    document.querySelector('.controls-bar').style.display = 'flex';	
				
				// Show the VideoPlayer again
				document.getElementById('videoPlayer').style.display = 'block';
			}

			function playAll() {
				// Logic to play all tracks in order
				alert('Playing all tracks in order');
			}

			function playRandom() {
				// Logic to play tracks in random order
				alert('Playing tracks in random order');
			}

		</script>
    </body>
</html>